---
title: CSRF where token is not tied to user session
date: 2025-10-5 00:00:00 +0800
categories: [Portswigger, Cross-site request forgery (CSRF)]
tags: [portswigger, writeup, walkthrough, web, csrf]     # TAG names should always be lowercase
description: In this post we will solve a CSRF Lab on portswigger, have fun reading.
---

## Lab: CSRF where token is not tied to user session

This lab's email change functionality is vulnerable to CSRF. It uses tokens to try to prevent CSRF attacks, but they aren't integrated into the site's session handling system.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You have two accounts on the application that you can use to help design your attack. The credentials are as follows:

- `wiener:peter`
- `carlos:montoya`

### Lab 4 Exploitation

Our goal is to exploit the vulnerable functionality in this website and make sure that the csrf vulnerability works so let's start 

First we will open burpsuite before doing anything so that we can see all of the requests that our website is doing, then login to `wiener` account with the credentials we have.

![img-description](/assets/img/PortSwigger/CSRF/4/mail.png)
_Changing Email_

We will find that we can change our account email so put any email and click on the update email and we will see that it is updated now, after we have seen that it is updated let's see our request in burpsuite.

![img-description](/assets/img/PortSwigger/CSRF/4/req.png)
_Request_

We will see that this is the request that changed our email, but they have managed to put a csrf token to block our attack so let's see how can we bypass that.

Send your request to Repeater `Ctrl+R` and we will try to remove the csrf token and we will see it will not work, second we will try to change the request method and we will see also it will not work, so now as the lab description says we will try another valid csrf token and try to change the email with it.

upon trying the website only accepts the csrf toke once and it will generate another new one every time so we will need to go and login with `carlos` account to get a valid csrf token (do not log out from wiener account open a new private tab and log in to carlos account).

![img-description](/assets/img/PortSwigger/CSRF/4/validCSRF.png)
_CSRF Token_

as we can see we can get a valid csrf token from the source code so take it and let's go back to our request in the repeater and change the csrf token and send the request again with a new email and see what will heppen.

![img-description](/assets/img/PortSwigger/CSRF/4/Trial.png)
_Changing Token_

And it worked, which means that if we send any valid csrf token with our request to the victim it will not validate if it is tied to this user session or not it will do our goal which is changing his email address, let's start sending it to our target via the exploit server.

let's craft our poc

```
<html>
    <body>
        <form action="https://vulnerable-website.com/email/change" method="Post">
            <input type="hidden" name="email" value="pwned@evil-user.net" />
            <input type="hidden" name="csrf" value="e9UChFXKQVguX6NnX8AAcYYhIsU37D1F" />
        </form>
        <script>
            document.forms[0].submit();
        </script>
    </body>
</html>
```
**Note:** you can get another csrf token by refreshing the carlos account page and you will find that it have been changed to another one which must be valid because we haven't used it yet

Change the data in this code with your lab relevant data, and make sure you have chosen a different mail again because no two users should have the same email.

![img-description](/assets/img/PortSwigger/CSRF/4/Exploit.png)
_POC_

and your request should be something like this, now Deliver exploit to victim.

![img-description](/assets/img/PortSwigger/CSRF/4/solved.png)
_Solved_

and you will see that the lab is solved.