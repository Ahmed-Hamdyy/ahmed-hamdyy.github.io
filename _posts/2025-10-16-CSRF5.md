---
title: CSRF where token is tied to non-session cookie
date: 2025-10-16 00:00:00 +0800
categories: [Portswigger, Cross-site request forgery (CSRF)]
tags: [portswigger, writeup, walkthrough, web, csrf]     # TAG names should always be lowercase
description: In this post we will solve a CSRF Lab on portswigger, have fun reading.
---

## Lab: CSRF where token is tied to non-session cookie

This lab's email change functionality is vulnerable to CSRF. It uses tokens to try to prevent CSRF attacks, but they aren't fully integrated into the site's session handling system.

To solve the lab, use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address.

You have two accounts on the application that you can use to help design your attack. The credentials are as follows:

wiener:peter
carlos:montoya

- `wiener:peter`
- `carlos:montoya`

### Lab 5 Exploitation

Our goal is to exploit the vulnerable functionality in this website and make sure that the csrf vulnerability works so let's start 

First we will open burpsuite before doing anything so that we can see all of the requests that our website is doing, then login to `wiener` account with the credentials we have.

![img-description](/assets/img/PortSwigger/CSRF/5/mail.png)
_Changing Email_

We will find that we can change our account email so put any email and click on the update email and we will see that it is updated now, after we have seen that it is updated let's see our request in burpsuite.

![img-description](/assets/img/PortSwigger/CSRF/5/req.png)
_Request_

We will see that this is the request that changed our email, but they have managed to put a csrf token and a csrf key to block our attack so let's see how can we bypass that.

Send your request to Repeater `Ctrl+R` and we will try to remove the csrf token and we will see it will not work, second we will try to change the request method and we will see also it will not work, and also if we changed only the csrf token we will see that it didn't worked so i think it is tied to the csrfKey cookie but may be not with the session cookie so let's try it.

upon trying the website only accepts the csrf token once and it will generate another new one every time so we will need to go and login with `carlos` account to get a valid csrf token (do not log out from wiener account open a new private tab and log in to carlos account).

![img-description](/assets/img/PortSwigger/CSRF/5/csrf.png)
_CSRF Token_

and also we need to get the csrfKey cookie also you can get it from burpsuite.

![img-description](/assets/img/PortSwigger/CSRF/5/key.png)
_CSRF Key_

Now replace this data with the data in the wiener account request but let the session cookie as it is and let's send the request.

![img-description](/assets/img/PortSwigger/CSRF/5/repeater.png)
_Changing Email_

and we can see that it worked, that's perfect but as we have learned from the past labs we can just send the request with another csrf token which is in the body and we can send it with the request and change it easily but now as we need also to change the **csrfKey** cookie which is in the request headers so how can we do this?

probably we will need to chain our csrf attack with another attack so upon searching i found this post talking about [HTTP Header Injection](https://www.acunetix.com/blog/web-security-zone/http-header-injection/) which is when the attacker tricks the web application into inserting extra HTTP headers into legitimate HTTP responses, and i think this is exactly what we want in order for our attack to work.

Now we need to find a way to try our attack which we can also call a [CRLF Injection](https://www.invicti.com/learn/crlf-injection/) attack, we will find that there is a search function so i will see the request in burp and we can see that we have typed is now be shown in the response so i think this will be our targeted function.

![img-description](/assets/img/PortSwigger/CSRF/5/search.png)
_Trying to Search_

From what we read about this attack and how to do it we will now try it in here to inject our csrfKey cookie and see what is gonna happen.

![img-description](/assets/img/PortSwigger/CSRF/5/crlf.png)
_CRLF_

Perfect we can now see that the cookie is right there so now all we need is just to craft our exploit in order to send it to our victim, in our script we will make the victim visit the search function with our CRLF Injection containing our cookie and when it will make an error as the website can't see this as an image it will submit the form with our csrf token and change the email and we will be having every thing in place.

```
<html>
    <body>
        <form action="https://0a7900cd044ad5b781471679002b0026.web-security-academy.net/my-account/change-email" method="Post">
            <input type="hidden" name="email" value="pwned@evil-user.net" />
            <input type="hidden" name="csrf" value="FDNn1cImHia7F7yVbtp4EcDsGp884hDR" />
        </form>
        <img src="https://0a7900cd044ad5b781471679002b0026.web-security-academy.net/?search=test%0d%0aSet-Cookie:%20csrfKey=MGinesUgQCqnMH4ksEWJmQqZKV0dXhM8" onerror="document.forms[0].submit()">
    </body>
</html>
```
**Note:** you can get another csrf token by refreshing the carlos account page and you will find that it have been changed to another one which must be valid because we haven't used it yet

Change the data in this code with your lab relevant data, and make sure you have chosen a different mail again because no two users should have the same email.

now Deliver exploit to victim.

![img-description](/assets/img/PortSwigger/CSRF/5/Solved.png)
_Solved_

and you will see that the lab is solved.